<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      /* Flexbox layout for word cloud and pie chart */
      .visualization-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 40px;
      }
      .visualization-container img,
      .visualization-container div {
        flex: 1;
      }
      #pie-chart {
        width: 100%;
        height: 400px;
      }
      #topic-time-series {
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <h1>Reddit Data Analysis Dashboard</h1>

    <!-- Search Bar -->
    <div>
      <h2>Search Posts</h2>
      <input type="text" id="search-query" placeholder="Enter a keyword or phrase" />
      <button onclick="handleSearch()">Search</button>
    </div>

    <!-- Time Series of Search Results -->
    <div id="search-time-series">
      <h2>Time Series of Posts Matching Search Query</h2>
      <div id="time-series-plot"></div>
    </div>

    <!-- Key Topics -->
    <div id="key-topics">
      <h2>Key Topics</h2>
      <ul>
        {% for topic in topics %}
        <li>{{ topic }}</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Time Series of Key Topics -->
    <div id="topic-time-series">
      <h2>Time Series of Key Topics</h2>
      <div id="topic-time-series-plot"></div>
    </div>

    <!-- Word Cloud and Pie Chart -->
    <div class="visualization-container">
      <!-- Word Cloud -->
      <div>
        <h2>Word Cloud of Post Titles</h2>
        <img
          id="wordcloud"
          src="data:image/png;base64,{{ wordcloud_img }}"
          alt="Word Cloud"
        />
      </div>

      <!-- Pie Chart -->
      <div>
        <h2>Top 10 Most Frequent Words</h2>
        <div id="pie-chart"></div>
      </div>
    </div>

    <!-- Fake News Distribution -->
    <h2>Fake News Distribution</h2>
    <div>{{ fake_news_plot | safe }}</div>

    <!-- Other Visualizations -->
    <h2>Distribution of Upvotes</h2>
    <div>{{ plot1 | safe }}</div>

    <h2>Upvotes vs. Number of Comments</h2>
    <div>{{ plot2 | safe }}</div>

    <h2>Top 10 Most Upvoted Posts</h2>
    <div>{{ plot3 | safe }}</div>

    <h2>Number of Posts Over Time</h2>
    <div>{{ plot4 | safe }}</div>

    <h2>Sentiment Analysis</h2>
    <h3>Sentiment Distribution of Post Titles</h3>
    <div>{{ sentiment_plot1 | safe }}</div>
    <h3>Average Sentiment Over Time</h3>
    <div>{{ sentiment_plot2 | safe }}</div>

    <script>
      // Function to update the pie chart
      function updatePieChart(labels, values) {
        Plotly.newPlot(
          "pie-chart",
          [
            {
              values: values,
              labels: labels,
              type: "pie",
            },
          ],
          {
            title: "Top 10 Most Frequent Words",
          }
        );
      }

      // Fetch the top 10 words and their frequencies when the page loads
      fetch("/top_words")
        .then((response) => response.json())
        .then((data) => {
          // Initialize the pie chart with the top 10 words
          updatePieChart(data.labels, data.values);
        });

      // Add click event listener to the word cloud
      document
        .getElementById("wordcloud")
        .addEventListener("click", function (event) {
          // Fetch the top 10 words and their frequencies
          fetch("/top_words")
            .then((response) => response.json())
            .then((data) => {
              // Update the pie chart
              updatePieChart(data.labels, data.values);
            });
        });

      // Handle search queries
      function handleSearch() {
        const query = document.getElementById("search-query").value;
        if (query) {
          fetch("/search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query: query }),
          })
            .then((response) => response.json())
            .then((data) => {
              // Update the time series plot
              Plotly.newPlot(
                "time-series-plot",
                [
                  {
                    x: data.dates,
                    y: data.counts,
                    type: "line",
                  },
                ],
                {
                  title: `Time Series of Posts Containing "${query}"`,
                  xaxis: { title: "Date" },
                  yaxis: { title: "Number of Posts" },
                }
              );
            });
        }
      }

      // Plot the time series of key topics
      const topicTimeSeries = JSON.parse('{{ topic_time_series | tojson | safe }}');
      const dates = Object.keys(topicTimeSeries);
      const topics = Object.keys(topicTimeSeries[dates[0]]);

      const data = topics.map(topic => ({
        x: dates,
        y: dates.map(date => topicTimeSeries[date][topic]),
        name: `Topic ${topic}`,
        type: 'line'
      }));

      Plotly.newPlot(
        "topic-time-series-plot",
        data,
        {
          title: "Time Series of Key Topics",
          xaxis: { title: "Date" },
          yaxis: { title: "Number of Posts" },
        }
      );
    </script>
  </body>
</html>